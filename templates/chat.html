<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="{{ url_for('static', filename='icon.png') }}" type="image/png">
    <title>é’é¸¾å‘å¯¼</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='chat.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.5/purify.min.js"></script>
</head>
<body>
    <div class="chat-container">
        <header>
            <div style="display:flex; align-items:center; gap:10px;">
                <img src="{{ url_for('static', filename='icon.png') }}" alt="Profile Picture">
                <h1>é’é¸¾å‘å¯¼</h1>
            </div>
            <div class="header-buttons">
                <button id="new-chat-btn" class="header-btn">
                    ğŸ†• æ–°å»ºå¯¹è¯
                </button>
                <button id="history-btn" class="header-btn">
                    ğŸ“œ å†å²å¯¹è¯
                </button>
                <a href="/travel" class="header-btn">
                    âœˆï¸ æ—…è¡Œè§„åˆ’
                </a>
            </div>
            <div class="user-info">
                <span>{{ email }}</span>
                <a href="/logout" class="logout-btn">ğŸšª é€€å‡º</a>
            </div>
        </header>

        <!-- èŠå¤©æ¡† -->
        <div class="chat-box" id="chat-box">
        </div>

        <div class="input-area">
            <div class="input-wrapper">
                <textarea id="message-input" placeholder="è¯·è¾“å…¥ä¿¡æ¯..." rows="2"></textarea>
                <button id="send-btn">å‘é€</button>
            </div>
        </div>
    </div>

    <!-- å†å²å¯¹è¯å¼¹çª— -->
    <div id="history-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; z-index:1000; justify-content:center; align-items:center;">
        <div style="width:90%; max-width:600px; overflow:hidden;">
            <div style="padding:20px 25px; border-bottom:1px solid rgba(102, 126, 234, 0.1); display:flex; justify-content:space-between; align-items:center;">
                <h3>ğŸ“œ å†å²å¯¹è¯</h3>
                <button id="close-history" style="background:none; border:none; color:#667eea; cursor:pointer; font-size:20px;">âœ–</button>
            </div>
            <div style="height:500px; overflow-y:auto; padding:20px; background:rgba(248, 249, 255, 0.5);">
                <div id="history-list">
                    <div style="text-align:center; color:#667eea; padding:20px;">åŠ è½½ä¸­...</div>
                </div>
            </div>
            <div style="padding:20px; border-top:1px solid rgba(102, 126, 234, 0.1); text-align:right; background:rgba(248, 249, 255, 0.5);">
                <button id="clear-history" style="margin-right:10px; padding:10px 20px; background:rgba(102, 126, 234, 0.1); border:2px solid rgba(102, 126, 234, 0.2); border-radius:10px; cursor:pointer; color:#667eea; font-weight:600;">æ¸…é™¤å†å²</button>
                <button id="close-history-btn" style="padding:10px 20px; background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); color:white; border:none; border-radius:10px; cursor:pointer; font-weight:600;">å…³é—­</button>
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='script.js') }}"></script>
    <script>
        // æ·»åŠ å¤åˆ¶æŒ‰é’®å‡½æ•°
        function addCopyButtons() {
            document.querySelectorAll('.ai-message pre').forEach(pre => {
                if (pre.dataset.hasCopy === 'true') return;

                pre.style.position = 'relative';
                const btn = document.createElement('button');
                btn.innerText = 'å¤åˆ¶';
                btn.className = 'copy-btn';

                btn.addEventListener('click', () => {
                    navigator.clipboard.writeText(pre.innerText.replace('å¤åˆ¶','').trim()).then(() => {
                        btn.innerText = 'å·²å¤åˆ¶';
                        setTimeout(() => btn.innerText = 'å¤åˆ¶', 2000);
                    });
                });

                pre.appendChild(btn);
                pre.dataset.hasCopy = 'true';
            });
        }

        // åˆå§‹é«˜äº®å’Œæ·»åŠ æŒ‰é’®
        document.addEventListener('DOMContentLoaded', () => {
            hljs.highlightAll();
            addCopyButtons();
        });
        
        // ç›‘å¬ DOM å˜åŒ–è‡ªåŠ¨æ·»åŠ å¤åˆ¶æŒ‰é’®å’Œé«˜äº®ä»£ç 
        const observer = new MutationObserver((mutations) => {
            let needsHighlighting = false;
            let needsCopyButtons = false;
            
            mutations.forEach((mutation) => {
                if (mutation.type === 'childList') {
                    mutation.addedNodes.forEach((node) => {
                        if (node.nodeType === Node.ELEMENT_NODE) {
                            // æ£€æŸ¥æ˜¯å¦æœ‰ä»£ç å…ƒç´ éœ€è¦é«˜äº®
                            if (node.querySelector && (node.querySelector('code') || node.querySelector('pre'))) {
                                needsHighlighting = true;
                            }
                            
                            // æ£€æŸ¥æ˜¯å¦æœ‰preå…ƒç´ éœ€è¦æ·»åŠ å¤åˆ¶æŒ‰é’®
                            if (node.querySelector && node.querySelector('pre')) {
                                needsCopyButtons = true;
                            }
                            
                            // å¦‚æœèŠ‚ç‚¹æœ¬èº«æ˜¯preæˆ–codeå…ƒç´ 
                            if (node.tagName === 'PRE' || node.tagName === 'CODE') {
                                needsHighlighting = true;
                                if (node.tagName === 'PRE') {
                                    needsCopyButtons = true;
                                }
                            }
                        }
                    });
                }
            });
            
            // æ‰¹é‡å¤„ç†ï¼Œé¿å…é‡å¤æ“ä½œ
            if (needsHighlighting) {
                // åº”ç”¨ä»£ç é«˜äº®
                const codeBlocks = document.querySelectorAll('pre code:not(.hljs)');
                codeBlocks.forEach(block => {
                    if (!block.className.includes('language-')) {
                        block.className = 'language-javascript';
                    }
                    hljs.highlightElement(block);
                });
                
                const inlineCodes = document.querySelectorAll('code:not(pre code):not(.hljs)');
                inlineCodes.forEach(code => {
                    if (!code.className.includes('language-')) {
                        code.className = 'language-javascript';
                    }
                    hljs.highlightElement(code);
                });
            }
            
            if (needsCopyButtons) {
                addCopyButtons();
            }
        });
        observer.observe(document.body, { childList: true, subtree: true });
    </script>
</body>
</html>