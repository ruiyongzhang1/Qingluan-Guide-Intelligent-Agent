<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="{{ url_for('static', filename='icon.png') }}" type="image/png">
    <title>é’é¸¾å‘å¯¼</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.5/purify.min.js"></script>
    <!-- æ·»åŠ äº†ä»¥ä¸‹ä»£ç  -->
</head>
<body>
    <div class="chat-container">
        <header>
            <div style="display:flex; align-items:center; gap:10px;">
                <img src="{{ url_for('static', filename='icon.png') }}" alt="Profile Picture" style="border-radius: 50%; width: 33.3px; height: 33.3px;">
                <h1>é’é¸¾å‘å¯¼</h1>
            </div>
            <div class="user-info">
                <span style="font-weight:bold;">{{ email }}</span>
                <a href="/logout" class="logout-btn">é€€å‡º</a>
            </div>
        </header>

        <div style="padding:0 20px;">
            <div style="display:flex; justify-content:space-between; margin:15px 0;">
                <div style="display:flex; gap:10px;">
                    <button id="new-chat-btn" style="background:none; border:none; color:var(--primary-color); cursor:pointer; display:flex; align-items:center; gap:5px;">
                          ğŸ†• æ–°å»ºå¯¹è¯
                    </button>
                    <button id="history-btn" style="background:none; border:none; color:var(--primary-color); cursor:pointer; display:flex; align-items:center; gap:5px;">
                          ğŸ“œ å†å²å¯¹è¯
                    </button>
                </div>
                <div style="color:var(--dark-color); font-size:0.9rem;">
                    <span id="current-time">åŠ è½½ä¸­...</span>
                </div>
            </div>
        </div>

        <hr style="margin:0; border: none; border-top: 1px solid #e0e0e0;">

        <!-- èŠå¤©æ¡† -->
        <body>
            <div class="chat-box" id="chat-box">
                <div id="requirements-container"></div>
            </div>
            <script src="{{ url_for('static', filename='script.js') }}"></script>
        </body>

        <div class="input-area">
            <div class="input-wrapper">
                <textarea id="message-input" placeholder="è¯·è¾“å…¥ä¿¡æ¯..." rows="2"></textarea>
                <button id="send-btn">å‘é€</button>
            </div>
        </div>
    </div>

    <!-- å†å²å¯¹è¯å¼¹çª— -->
    <div id="history-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background-color:rgba(0,0,0,0.5); z-index:1000; justify-content:center; align-items:center;">
        <div style="background-color:white; width:90%; max-width:600px; border-radius:10px; overflow:hidden; box-shadow:0 5px 30px rgba(0,0,0,0.2);">
            <div style="padding:15px 20px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center;">
                <h3 style="color:var(--primary-color);">å†å²å¯¹è¯</h3>
                <button id="close-history" style="background:none; border:none; color:var(--dark-color); cursor:pointer;">âœ–</button>
            </div>
            <div style="height:500px; overflow-y:auto; padding:15px; background-color:#f9f9f9;">
                <div id="history-list">
                    <div style="text-align:center; color:#999; padding:20px;">åŠ è½½ä¸­...</div>
                </div>
            </div>
            <div style="padding:15px; border-top:1px solid #eee; text-align:right;">
                <button id="clear-history" style="margin-right:10px; padding:8px 15px; background-color:#f8f9fa; border:1px solid #ddd; border-radius:5px; cursor:pointer;">æ¸…é™¤å†å²</button>
                <button id="close-history-btn" style="padding:8px 15px; background-color:var(--primary-color); color:white; border:none; border-radius:5px; cursor:pointer;">å…³é—­</button>
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='script.js') }}"></script>
    <script>
        function updateTime() {
            const now = new Date();
            document.getElementById('current-time').textContent = now.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
        }
        updateTime();
        setInterval(updateTime, 60000);
        // æ·»åŠ å¤åˆ¶æŒ‰é’®å‡½æ•°
        function addCopyButtons() {
            document.querySelectorAll('.ai-message pre').forEach(pre => {
                if (pre.dataset.hasCopy === 'true') return;

                pre.style.position = 'relative';
                const btn = document.createElement('button');
                btn.innerText = 'å¤åˆ¶';
                btn.className = 'copy-btn';

                btn.addEventListener('click', () => {
                    navigator.clipboard.writeText(pre.innerText.replace('å¤åˆ¶','').trim()).then(() => {
                        btn.innerText = 'å·²å¤åˆ¶';
                        setTimeout(() => btn.innerText = 'å¤åˆ¶', 2000);
                    });
                });

                pre.appendChild(btn);
                pre.dataset.hasCopy = 'true';
            });
        }

        // åˆå§‹é«˜äº®å’Œæ·»åŠ æŒ‰é’®
        document.addEventListener('DOMContentLoaded', () => {
            hljs.highlightAll();
            addCopyButtons();
        });
        
        // ç›‘å¬ DOM å˜åŒ–è‡ªåŠ¨æ·»åŠ å¤åˆ¶æŒ‰é’®å’Œé«˜äº®ä»£ç 
        const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                if (mutation.type === 'childList') {
                    mutation.addedNodes.forEach((node) => {
                        if (node.nodeType === Node.ELEMENT_NODE) {
                            // ä¸ºæ–°æ·»åŠ çš„ä»£ç å—åº”ç”¨é«˜äº®
                            const codeBlocks = node.querySelectorAll ? node.querySelectorAll('pre code') : [];
                            codeBlocks.forEach(block => {
                                if (!block.className.includes('language-')) {
                                    block.className = 'language-javascript';
                                }
                                hljs.highlightElement(block);
                            });
                            
                            // ä¸ºæ–°æ·»åŠ çš„è¡Œå†…ä»£ç åº”ç”¨é«˜äº®
                            const inlineCodes = node.querySelectorAll ? node.querySelectorAll('code:not(pre code)') : [];
                            inlineCodes.forEach(code => {
                                if (!code.className.includes('language-')) {
                                    code.className = 'language-javascript';
                                }
                                hljs.highlightElement(code);
                            });
                            
                            // ç¡®ä¿æ‰€æœ‰ä»£ç å…ƒç´ éƒ½è¢«æ­£ç¡®é«˜äº®
                            const allCodes = node.querySelectorAll ? node.querySelectorAll('code') : [];
                            allCodes.forEach(code => {
                                if (!code.classList.contains('hljs')) {
                                    hljs.highlightElement(code);
                                }
                            });
                            
                            // ä¸ºæ–°æ·»åŠ çš„preå…ƒç´ æ·»åŠ å¤åˆ¶æŒ‰é’®
                            const preElements = node.querySelectorAll ? node.querySelectorAll('pre') : [];
                            preElements.forEach(pre => {
                                if (!pre.dataset.hasCopy) {
                                    addCopyButtons();
                                }
                            });
                        }
                    });
                }
            });
        });
        observer.observe(document.body, { childList: true, subtree: true });
    </script>
</body>
</html>